{% extends 'base.html' %} {% load static %} {% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h1 class="h2">Dashboard</h1>
  <div class="btn-toolbar mb-2 mb-md-0"></div>
</div>

<section class="mb-4">
  <h2>Budget Overview</h2>
  <div class="card">
    <div class="card-body">
      <div
        class="row row-cols-1 row-cols-md-3 g-4"
        id="budgetCategoryContainer"
      >
        <div class="col">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Monthly Budget</h5>
              <p class="card-text budget-display">
                Budget: ${{ template_data.monthly_budget|floatformat:2 }} {# Format currency #}
              </p>
              <p class="card-text">
                Spent: $<span id="totalSpentDisplay"
                  >{{ template_data.total_spent|floatformat:2 }}</span
                >
              </p>
              {% if template_data.total_spent > template_data.monthly_budget %}
              <div class="alert alert-warning mt-2" role="alert">
                ⚠️ Over Budget!
              </div>
              {% endif %}
              <div class="progress">
                 {# Calculate percentage dynamically #}
                {% with percentage=0 %}
                    {% if template_data.monthly_budget > 0 %}
                        {% widthratio template_data.total_spent template_data.monthly_budget 100 as percentage %}
                    {% endif %}
                    <div
                      class="progress-bar {% if percentage > 100 %}bg-danger{% elif percentage > 85 %}bg-warning{% else %}bg-success{% endif %}"
                      style="width: {% if percentage > 100 %}100{% else %}{{ percentage }}{% endif %}%"
                      role="progressbar"
                      aria-valuenow="{{ percentage }}"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                {% endwith %}
              </div>
              <button
                class="btn btn-sm btn-outline-secondary mt-2"
                data-bs-toggle="modal"
                data-bs-target="#adjustBudgetModal"
              >
                Adjust Budget
              </button>
              {# Removed redundant alert #}
            </div>
          </div>
        </div>

        {% for category in template_data.budget_categories %}
        <div class="col" id="category-card-{{ category.id }}">
          <div class="card h-100">
            <div class="card-body position-relative">
              <h5 class="card-title">{{ category.name }}</h5>
              <p class="card-text">
                Budget: ${{ category.budget_limit|floatformat:2 }}
              </p>
              <p class="card-text">
                Spent: $<span id="category-spent-{{ category.id }}"
                  >{{ category.amount_spent|floatformat:2 }}</span
                >
              </p>
              {% if category.amount_spent > category.budget_limit %}
              <div class="alert alert-warning mt-2" role="alert">
                ⚠️ Over Budget!
              </div>
              {% endif %}
              <div class="progress mb-4">
                 {% with cat_percentage=0 %}
                    {% if category.budget_limit > 0 %}
                        {% widthratio category.amount_spent category.budget_limit 100 as cat_percentage %}
                    {% endif %}
                    <div
                      class="progress-bar {% if cat_percentage > 100 %}bg-danger{% elif cat_percentage > 85 %}bg-warning{% else %}bg-info{% endif %}"
                      style="width: {% if cat_percentage > 100 %}100{% else %}{{ cat_percentage }}{% endif %}%"
                      role="progressbar"
                      aria-valuenow="{{ cat_percentage }}"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                {% endwith %}
              </div>
              <button
                  type="button"
                  class="btn btn-sm btn-outline-danger delete-category-btn position-absolute bottom-0 end-0 mb-2 me-2"
                  data-category-id="{{ category.id }}"
                  data-category-name="{{ category.name|escapejs }}"
                  title="Delete Category"
              >
                  <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {# Action Buttons #}
      <button
        class="btn btn-sm btn-primary mt-3"
        data-bs-toggle="modal"
        data-bs-target="#addCategoryModal"
      >
        <i class="fa fa-plus me-1"></i> Add Category
      </button>
      <button
        class="btn btn-sm btn-success mt-3 ms-2"
        data-bs-toggle="modal"
        data-bs-target="#addTransactionModal"
      >
        <i class="fa fa-plus me-1"></i> Add Transaction
      </button>
    </div>
  </div>
</section>

<div
  class="modal fade"
  id="adjustBudgetModal"
  tabindex="-1"
  aria-labelledby="adjustBudgetModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adjustBudgetModalLabel">
          Adjust Monthly Budget
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        {# Use namespaced URL name #}
        <form
          id="adjustBudgetForm"
          method="post"
          action="{% url 'dashboard.adjust_budget' %}" {# Assuming 'dashboard' is your namespace #}
        >
          {% csrf_token %}
          <div class="mb-3">
            <label for="new_budget" class="form-label"
              >New Monthly Budget:</label
            >
            <input
              type="number"
              class="form-control"
              id="new_budget"
              name="new_budget"
              value="{{ template_data.monthly_budget|floatformat:2 }}"
              step="0.01"
              min="0"
              required
            />
            <div class="invalid-feedback" id="error_new_budget"></div>
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="addCategoryModal"
  tabindex="-1"
  aria-labelledby="addCategoryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCategoryModalLabel">
          Add New Budget Category
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
         <div id="categoryErrorAlert" class="alert alert-danger" style="display: none;" role="alert"></div>
         {# Use namespaced URL name #}
        <form
          id="addCategoryForm"
          method="post"
          action="{% url 'dashboard.add_budget_category' %}" {# Assuming 'dashboard' is your namespace #}
        >
          {% csrf_token %}
          <div class="mb-3">
            <label for="category_name" class="form-label">Category Name:</label>
            <input
              type="text"
              class="form-control"
              id="category_name"
              name="category_name"
              required
            />
            <div class="invalid-feedback" id="error_category_name"></div>
          </div>
          <div class="mb-3">
            <label for="category_limit" class="form-label">Budget Limit:</label>
            <input
              type="number"
              class="form-control"
              id="category_limit"
              name="category_limit"
              step="0.01"
              min="0"
              required
            />
            <div class="invalid-feedback" id="error_category_limit"></div>
          </div>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="addTransactionModal"
  tabindex="-1"
  aria-labelledby="addTransactionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTransactionModalLabel">
          Add New Transaction
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div
          id="transactionErrorAlert"
          class="alert alert-danger"
          style="display: none"
          role="alert"
        ></div>
         {# Use namespaced URL name #}
        <form
          id="addTransactionForm"
          method="post"
          action="{% url 'dashboard.add_transaction' %}" {# Assuming 'dashboard' is your namespace #}
        >
          {% csrf_token %}
          {% if template_data.transaction_form %}
              <div class="mb-3">
                <label
                  for="{{ template_data.transaction_form.category.id_for_label }}"
                  class="form-label"
                  >{{ template_data.transaction_form.category.label }}</label
                >
                {# Ensure select element has ID 'id_category' if that's what JS uses #}
                {{ template_data.transaction_form.category }}
                <div class="invalid-feedback" id="error_category"></div>
              </div>
              <div class="mb-3">
                <label
                  for="{{ template_data.transaction_form.amount.id_for_label }}"
                  class="form-label"
                  >{{ template_data.transaction_form.amount.label }}</label
                >
                {{ template_data.transaction_form.amount }}
                <div class="invalid-feedback" id="error_amount"></div>
              </div>
              <div class="mb-3">
                <label
                  for="{{ template_data.transaction_form.description.id_for_label }}"
                  class="form-label"
                  >{{ template_data.transaction_form.description.label }}</label
                >
                {{ template_data.transaction_form.description }}
                <div class="invalid-feedback" id="error_description"></div>
              </div>
              <div class="mb-3">
                <label
                  for="{{ template_data.transaction_form.date.id_for_label }}"
                  class="form-label"
                  >{{ template_data.transaction_form.date.label }}</label
                >
                {{ template_data.transaction_form.date }}
                <div class="invalid-feedback" id="error_date"></div>
              </div>
          {% else %}
              <p class="text-danger">Transaction form not available.</p>
          {% endif %}
          <button type="submit" class="btn btn-primary">Add Transaction</button>
        </form>
      </div>
    </div>
  </div>
</div>

<section class="mb-4">
  <h2>Connect External Accounts</h2>
  <div class="card">
      <div class="card-body">
          <p>Securely link your external bank accounts via Stripe to automatically sync transactions.</p>
           {# Use namespaced URL name #}
          <form action="{% url 'dashboard.connect_stripe' %}" method="post"> {# Assuming 'dashboard' is your namespace #}
              {% csrf_token %}
              <button type="submit" class="btn btn-primary">
                  <i class="fab fa-stripe me-2"></i>Connect with Stripe
                  </button>
          </form>
           <small class="d-block text-muted mt-2">You will be redirected to Stripe to securely log in or sign up.</small>
      </div>
  </div>
</section>

<section class="mb-4">
  <h2>Recent Transactions</h2>
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Category</th>
                <th scope="col">Description</th>
                <th scope="col" class="text-end">Amount</th>
              </tr>
            </thead>
            <tbody id="transactionListBody">
              {% for transaction in template_data.recent_transactions %}
              <tr id="transaction-row-{{ transaction.id }}">
                <td>{{ transaction.date|date:"Y-m-d" }}</td>
                <td>{{ transaction.category.name }}</td>
                <td>{{ transaction.description|default:"-" }}</td>
                <td class="text-end text-danger">
                  -${{ transaction.amount|floatformat:2 }}
                </td>
              </tr>
              {% empty %}
              <tr id="no-transactions-row">
                <td colspan="4" class="text-center">
                  No transactions recorded yet.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
       </div>
    </div>
  </div>
</section>

<section class="mb-4">
  <h2>Overview</h2>
  <div class="row">
    <div class="col-md-4 mb-3 mb-md-0">
      <div class="card h-100">
        <div class="card-header">Today's Spending</div>
        <div class="card-body">
          <p class="card-text fs-4" id="todaySpentDisplay">
            ${{ template_data.today_spent|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3 mb-md-0">
      <div class="card h-100">
        <div class="card-header">This Week's Spending</div>
        <div class="card-body">
          <p class="card-text fs-4" id="weekSpentDisplay">
            ${{ template_data.week_spent|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header">This Month's Spending</div>
        <div class="card-body">
          <p class="card-text fs-4" id="monthSpentDisplay">
            ${{ template_data.month_spent|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="mb-4">
  <h2>Spending by Category</h2>
  <div class="card">
    <div class="card-body">
      <div id="moneyFlowChart" style="width: 100%; height: 400px"></div>
      <button class="btn btn-sm btn-outline-secondary mt-2">
        View Detailed Categories
      </button>
    </div>
  </div>
</section>

<section class="mb-4" id="spendingHabitsReportSection"> {# Added ID for easier selection #}
  <h2>Spending Habits Report</h2>
  <div class="card">
    <div class="card-body">
      {# Initial content for the report card #}
      <p>
        AI Insight: You spent significantly more on dining out last month
        compared to the previous month. {# Placeholder #}
      </p>
      <img
        src="{% static 'img/money_flow_placeholder.png' %}"
        alt="Money Flow Placeholder"
        class="img-fluid"
        onerror="this.style.display='none'"
      />
      <button class="btn btn-sm btn-outline-secondary mt-2 generate-report-btn">Generate Full Report</button>
      <button class="btn btn-sm btn-info mt-2">Input Income</button>
    </div>
  </div>
</section>

<section class="mb-4">
  <h2>Personalized Finance Tips</h2>
  <div class="card">
    <div class="card-body">
      <p>
        <i class="fa fa-lightbulb me-2"></i>Tip: Consider reducing your
        subscriptions by reviewing unused services. {# Placeholder #}
      </p>
      <p>
        <i class="fa fa-lightbulb me-2"></i>Tip: Setting up automatic transfers
        to a savings account can help you save consistently. {# Placeholder #}
      </p>
    </div>
  </div>
</section>

<div class="form-check form-switch mb-3">
  <input class="form-check-input" type="checkbox" id="darkModeToggle" />
  <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
</div>

{# Add Font Awesome if not already in base.html #}
{# <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> #}

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
  body.dark-mode { background-color: #121212; color: #e0e0e0; }
  .card.dark-mode { background-color: #1e1e1e; color: #e0e0e0; border-color: #333; }
  .card-header.dark-mode { background-color: #2a2a2a; color: #e0e0e0; border-bottom-color: #333; }
  .modal-content.dark-mode { background-color: #1e1e1e; color: #e0e0e0; }
  .modal-header.dark-mode { border-bottom-color: #333; }
  .modal-footer.dark-mode { border-top-color: #333; }
  .form-control.dark-mode, .form-select.dark-mode { background-color: #2a2a2a; color: #e0e0e0; border-color: #444; }
  .form-control.dark-mode:focus, .form-select.dark-mode:focus { background-color: #333; color: #fff; border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
  .form-label.dark-mode { color: #e0e0e0; }
  .btn-close.dark-mode { filter: invert(1) grayscale(100%) brightness(200%); }
  .btn-outline-secondary.dark-mode { color: #adb5bd; border-color: #555; }
  .btn-outline-secondary.dark-mode:hover { background-color: #333; color: #fff; border-color: #555; }
  .progress-bar.dark-mode { /* Optional custom dark styles */ }
  .alert-warning.dark-mode { background-color: #332701; border-color: #ffc107; color: #ffc107; }
  .table.dark-mode { color: #e0e0e0; border-color: #333; }
  .table-striped.dark-mode tbody tr:nth-of-type(odd) { background-color: rgba(255, 255, 255, 0.05); }
  .table-hover.dark-mode tbody tr:hover { background-color: rgba(255, 255, 255, 0.075); }
  .is-invalid { border-color: #dc3545 !important; }
  .invalid-feedback { display: none; width: 100%; margin-top: 0.25rem; font-size: 0.875em; color: #dc3545; }
  .form-control.is-invalid ~ .invalid-feedback, .form-select.is-invalid ~ .invalid-feedback { display: block; }
  .text-danger { color: #dc3545 !important; }
  .delete-category-btn i { pointer-events: none; }
</style>

<script>
    // --- Helper Functions (Defined Globally within Script Tag) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken'); // Get CSRF token once

    function clearFormErrors(form) {
        if (!form) return;
        form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        form.querySelectorAll('.invalid-feedback').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        const transactionErrorAlert = document.getElementById('transactionErrorAlert');
        const categoryErrorAlert = document.getElementById('categoryErrorAlert');
        if(transactionErrorAlert) transactionErrorAlert.style.display = 'none';
        if(categoryErrorAlert) categoryErrorAlert.style.display = 'none';
    }

    function handleFormErrors(form, formErrors, errorAlertElement, generalError) {
         if (!form) return;
         clearFormErrors(form);
         let firstErrorField = null;
         if (formErrors) {
             for (const [field, messages] of Object.entries(formErrors)) {
                 const inputElement = form.querySelector(`[name="${field}"], #id_${field}`); // Common patterns
                 let feedbackElement = null;
                 if (inputElement) {
                    feedbackElement = inputElement.nextElementSibling; // Check sibling first
                    if (!feedbackElement || !feedbackElement.classList.contains('invalid-feedback')) {
                       feedbackElement = form.querySelector(`#error_${field}`); // Fallback to specific ID
                    }
                    inputElement.classList.add('is-invalid');
                    if (!firstErrorField) firstErrorField = inputElement;
                    if (feedbackElement && messages.length > 0) {
                       feedbackElement.textContent = messages[0];
                       feedbackElement.style.display = 'block';
                    }
                 } else if (field === '__all__') { // Handle Django's non-field errors
                     generalError = (generalError ? generalError + '<br>' : '') + messages.join('<br>');
                 } else {
                     console.warn(`Could not find input element for field: ${field}`);
                 }
             }
         }
         if (generalError) {
             if (errorAlertElement) {
                 errorAlertElement.innerHTML = generalError; // Use innerHTML for potential <br>
                 errorAlertElement.style.display = 'block';
             } else {
                 alert(`Error: ${generalError}`); // Fallback alert
             }
         }
    }

    function updateCategoryCardDisplay(categoryId, newSpentStr, budgetLimitStr) {
         const categorySpentSpan = document.getElementById(`category-spent-${categoryId}`);
         const categoryCard = document.getElementById(`category-card-${categoryId}`);
         if (!categorySpentSpan || !categoryCard) return;
         const newSpent = parseFloat(newSpentStr);
         const budgetLimit = parseFloat(budgetLimitStr);
         categorySpentSpan.textContent = newSpent.toFixed(2);
         const progressBar = categoryCard.querySelector('.progress-bar');
         if (progressBar) {
             const percentage = budgetLimit > 0 ? Math.min(100, (newSpent / budgetLimit) * 100) : (newSpent > 0 ? 100 : 0); // Handle 0 budget
             const percentageInt = Math.round(percentage);
             progressBar.style.width = `${percentage}%`;
             progressBar.setAttribute('aria-valuenow', percentageInt);
             progressBar.classList.remove('bg-info', 'bg-success', 'bg-warning', 'bg-danger');
             if (newSpent > budgetLimit && budgetLimit > 0) { // Only show danger if limit > 0
                 progressBar.classList.add('bg-danger');
                 progressBar.style.width = '100%'; // Cap visual width
             } else if (percentage > 85) {
                 progressBar.classList.add('bg-warning');
             } else {
                 progressBar.classList.add('bg-info'); // Default color
             }
         }
         let warningAlert = categoryCard.querySelector('.alert-warning');
         if (newSpent > budgetLimit && budgetLimit > 0) { // Check budgetLimit > 0 before showing warning
             if (!warningAlert) {
                 const newAlert = document.createElement('div');
                 newAlert.className = 'alert alert-warning mt-2';
                 newAlert.setAttribute('role', 'alert');
                 newAlert.innerHTML = '⚠️ Over Budget!';
                 const spentP = categorySpentSpan.closest('p');
                 if (spentP) spentP.parentNode.insertBefore(newAlert, spentP.nextSibling);
                 if (document.body.classList.contains('dark-mode')) {
                     applyDarkModeStyles(newAlert);
                 }
             }
         } else {
             if (warningAlert) {
                 warningAlert.remove();
             }
         }
    }

    function applyDarkModeStyles(element) {
         if (!element) return;
         const isDarkModeActive = document.body.classList.contains('dark-mode');
         // Card elements
         if (element.matches && element.matches('.card')) {
             element.classList.toggle('dark-mode', isDarkModeActive);
             element.querySelector('.card-header')?.classList.toggle('dark-mode', isDarkModeActive);
             element.querySelectorAll('.btn-outline-secondary').forEach(btn => btn.classList.toggle('dark-mode', isDarkModeActive));
             element.querySelectorAll('.progress-bar').forEach(bar => bar.classList.toggle('dark-mode', isDarkModeActive));
             element.querySelectorAll('.alert-warning').forEach(alert => alert.classList.toggle('dark-mode', isDarkModeActive));
         }
         // Specific alert element
         else if (element.matches && element.matches('.alert-warning')) {
            element.classList.toggle('dark-mode', isDarkModeActive);
         }
         // Modal elements
         else if (element.matches && element.matches('.modal')) {
             element.querySelector('.modal-content')?.classList.toggle('dark-mode', isDarkModeActive);
             element.querySelector('.modal-header')?.classList.toggle('dark-mode', isDarkModeActive);
             element.querySelector('.modal-footer')?.classList.toggle('dark-mode', isDarkModeActive);
             element.querySelectorAll('.form-control, .form-select').forEach(input => input.classList.toggle('dark-mode', isDarkModeActive));
             element.querySelectorAll('.form-label').forEach(label => label.classList.toggle('dark-mode', isDarkModeActive));
             element.querySelector('.btn-close')?.classList.toggle('dark-mode', isDarkModeActive);
         }
         // Table rows
         else if (element.tagName === 'TR') {
              element.classList.toggle('dark-mode-row', isDarkModeActive); // Example custom class
         }
    }

    // --- Plotly Chart Setup (Variables accessible within script) ---
    let plotLayout = {
        title: 'Spending by Category',
        xaxis: { title: 'Category', automargin: true },
        yaxis: { title: 'Amount Spent ($)', tickformat: '.2f', automargin: true },
        margin: { l: 60, r: 20, t: 40, b: 80 }, // Adjust margins as needed
        paper_bgcolor: '#fff', plot_bgcolor: '#fff', font: { color: '#000' } // Light mode defaults
    };
    let chartCategories = [];
    let chartSpending = [];
    let chartData = [{ x: chartCategories, y: chartSpending, type: 'bar', width: 0.3, marker: { color: 'rgb(91, 192, 222)' } }];

    function toggleDarkMode() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        // Toggle classes on static elements
        document.querySelectorAll('.card').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
        document.querySelectorAll('.card-header').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
        document.querySelectorAll('.modal').forEach(applyDarkModeStyles); // Apply to all modals
        document.querySelectorAll('.table').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
        document.querySelectorAll('.btn-outline-secondary').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
        document.querySelectorAll('.progress-bar').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
        document.querySelectorAll('.alert-warning').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
        // Add other static elements that need toggling

        // Update Plotly chart layout
        plotLayout.paper_bgcolor = isDarkMode ? '#1e1e1e' : '#fff';
        plotLayout.plot_bgcolor = isDarkMode ? '#1e1e1e' : '#fff';
        plotLayout.font.color = isDarkMode ? '#e0e0e0' : '#000';
        const moneyFlowChartDiv = document.getElementById('moneyFlowChart');
        if (moneyFlowChartDiv && typeof Plotly !== 'undefined') {
            Plotly.react(moneyFlowChartDiv, chartData, plotLayout); // Use react to update layout
        }
        // Store preference
        localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
    }

    // --- Functions for Generate Report ---
    function findSpendingHabitsSection() {
        // Use the ID added to the section for reliability
        return document.getElementById('spendingHabitsReportSection');
    }

    function collectBudgetData() {
        const budgetDisplayEl = document.querySelector('.budget-display');
        const totalSpentEl = document.getElementById('totalSpentDisplay'); // Correct ID

        const monthlyBudgetText = budgetDisplayEl ? budgetDisplayEl.textContent : 'Budget: $0';
        const monthlyBudget = parseFloat(monthlyBudgetText.replace(/[^0-9.]/g, '')) || 0;

        const totalSpentText = totalSpentEl ? totalSpentEl.textContent : '0';
        const totalSpent = parseFloat(totalSpentText.replace(/[^0-9.]/g, '')) || 0;

        const categories = [];
        const categoryContainer = document.getElementById('budgetCategoryContainer');
        if (categoryContainer) {
            // Select category cards more reliably by checking for delete button presence
            const categoryCards = categoryContainer.querySelectorAll('.col .card');

            categoryCards.forEach(card => {
                 // Skip the main budget card (which doesn't have a delete button)
                 if (!card.querySelector('.delete-category-btn')) {
                     return;
                 }

                 const cardBody = card.querySelector('.card-body');
                 if (!cardBody) return;

                 const titleElement = cardBody.querySelector('.card-title');
                 const budgetPara = Array.from(cardBody.querySelectorAll('p.card-text')).find(p => p.textContent.includes('Budget:'));
                 const spentPara = Array.from(cardBody.querySelectorAll('p.card-text')).find(p => p.textContent.includes('Spent:'));
                 const spentSpan = spentPara?.querySelector('span[id^="category-spent-"]'); // Find the span inside

                 if (titleElement && budgetPara && spentSpan) {
                     const name = titleElement.textContent.trim();
                     const budget = parseFloat(budgetPara.textContent.replace(/[^0-9.]/g, '')) || 0;
                     const spent = parseFloat(spentSpan.textContent.replace(/[^0-9.]/g, '')) || 0;

                     categories.push({
                         name: name,
                         budget: budget,
                         spent: spent,
                         over_budget: budget > 0 && spent > budget,
                         percentage: budget > 0 ? (spent / budget) * 100 : (spent > 0 ? Infinity : 0)
                     });
                 }
            });
        }
        return { monthly_budget: monthlyBudget, total_spent: totalSpent, remaining: monthlyBudget - totalSpent, over_budget: totalSpent > monthlyBudget, categories: categories };
    }

    function generateMockReport(budgetData) {
        const overBudget = budgetData.total_spent > budgetData.monthly_budget;
        const budgetStatus = overBudget ?
            `<div class="alert alert-danger small">You are $${(budgetData.total_spent - budgetData.monthly_budget).toFixed(2)} over budget this month!</div>` :
            `<div class="alert alert-success small">You have $${(budgetData.monthly_budget - budgetData.total_spent).toFixed(2)} remaining.</div>`;
        const budgetPercentage = budgetData.monthly_budget > 0 ? Math.min(Math.round((budgetData.total_spent / budgetData.monthly_budget) * 100), 100) : (budgetData.total_spent > 0 ? 100 : 0);
        const progressBarColor = overBudget ? 'bg-danger' : (budgetPercentage > 85 ? 'bg-warning' : 'bg-success'); // Adjusted threshold
        const progressBar = `<div class="progress mb-3" style="height: 20px;"><div class="progress-bar ${progressBarColor}" role="progressbar" style="width: ${budgetPercentage}%" aria-valuenow="${budgetPercentage}" aria-valuemin="0" aria-valuemax="100">${budgetPercentage}% Used</div></div>`;

        let categoryAnalysis = '';
        let recommendations = '';
        if (budgetData.categories.length === 0) {
            categoryAnalysis = '<p>No budget categories found.</p>';
        } else {
            const sortedCategories = [...budgetData.categories].sort((a, b) => b.percentage - a.percentage);
            categoryAnalysis = '<div class="row g-3">'; // Use g-3 for gutter
            sortedCategories.forEach(category => {
                const percentage = category.budget > 0 ? Math.min(Math.round(category.percentage), 100) : (category.spent > 0 ? 100 : 0);
                const cardClass = category.over_budget ? 'border-danger' : (percentage > 85 ? 'border-warning' : ''); // Removed success border
                const barColor = category.over_budget ? 'bg-danger' : (percentage > 85 ? 'bg-warning' : 'bg-info'); // Use info as default
                const overAmount = category.over_budget ? ` <span class="text-danger small">(Over by $${(category.spent - category.budget).toFixed(2)})</span>` : '';

                categoryAnalysis += `
                    <div class="col-md-6">
                        <div class="card ${cardClass} h-100 shadow-sm">
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title mb-1">${category.name}${overAmount}</h6>
                                <p class="card-text small text-muted mb-2">Budget: $${category.budget.toFixed(2)} / Spent: $${category.spent.toFixed(2)}</p>
                                <div class="progress mt-auto" style="height: 8px;"> <div class="progress-bar ${barColor}" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div> </div>
                                <p class="card-text small text-center text-muted mt-1 mb-0">${percentage}% Spent</p>
                            </div>
                        </div>
                    </div>`;
                // Recommendations
                if (category.over_budget) { recommendations += `<li class="list-group-item list-group-item-danger small">Review <strong>${category.name}</strong> spending. You're $${(category.spent - category.budget).toFixed(2)} over budget.</li>`; }
                else if (percentage > 85) { recommendations += `<li class="list-group-item list-group-item-warning small">Spending in <strong>${category.name}</strong> is high (${percentage}%). $${(category.budget - category.spent).toFixed(2)} remaining.</li>`; }
            });
            categoryAnalysis += '</div>';
            if (recommendations === '') { recommendations = '<li class="list-group-item list-group-item-success small">Great job staying within budget in all categories!</li>'; }
            recommendations += `<li class="list-group-item small">Consider setting up automatic savings transfers.</li>`;
            recommendations += `<li class="list-group-item small">Review subscriptions for potential savings.</li>`;
        }
        return `<div class="report-section mb-4"><h5>Overall Budget Health</h5>${budgetStatus}${progressBar}</div><div class="report-section mb-4"><h5>Category Breakdown</h5>${categoryAnalysis}</div><div class="report-section"><h5>Recommendations</h5><ul class="list-group list-group-flush">${recommendations}</ul></div>`;
    }

    function downloadReport(reportContent) {
         const htmlContent = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Personal Spending Report</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"><style>body { padding: 20px; }.report-header { margin-bottom: 20px; text-align: center; }.report-date { margin-bottom: 20px; text-align: right; color: #666; }</style></head><body><div class="container py-4"><div class="report-header"><h1>Personal Spending Report</h1><p class="report-date">Generated on ${new Date().toLocaleDateString()}</p></div><div class="report-content">${reportContent}</div></div></body></html>`;
         const blob = new Blob([htmlContent], { type: 'text/html' });
         const url = URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.href = url;
         a.download = `spending-report-${new Date().toISOString().slice(0, 10)}.html`;
         document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    async function handleGenerateReport() {
        console.log("Generate Report button clicked!");
        const reportSection = findSpendingHabitsSection(); // Use updated function
        if (!reportSection) { console.error("Could not find Spending Habits Report section"); return; }
        const reportCardBody = reportSection.querySelector('.card-body');
        if (!reportCardBody) { console.error("Could not find card body"); return; }

        const originalContent = reportCardBody.innerHTML; // Save original state
        // Show loading spinner more prominently
        reportCardBody.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 mb-0">Generating report...</p></div>`;

        try {
            const budgetData = collectBudgetData(); // Use updated function
            console.log("Budget data collected:", budgetData);
            const reportHTML = generateMockReport(budgetData); // Use updated function

            await new Promise(resolve => setTimeout(resolve, 1200)); // Simulate delay

            // Display the report
            reportCardBody.innerHTML = `
                <h5 class="card-title">Personalized Spending Report</h5>
                <div class="report-content mb-3">${reportHTML}</div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-sm btn-outline-secondary close-report-btn">Close Report</button>
                    <button class="btn btn-sm btn-primary download-report-btn">Download Report</button>
                </div>`;

            // Add event listeners to new buttons within the updated card body
            reportCardBody.querySelector('.close-report-btn')?.addEventListener('click', () => {
                reportCardBody.innerHTML = originalContent;
                // Re-attach listener to the original button if it exists in originalContent
                reportCardBody.querySelector('.generate-report-btn')?.addEventListener('click', handleGenerateReport);
            });
            reportCardBody.querySelector('.download-report-btn')?.addEventListener('click', () => downloadReport(reportHTML));

        } catch (error) {
            console.error("Error generating report:", error);
            reportCardBody.innerHTML = `<div class="alert alert-danger"><h5>Error</h5><p>${error.message || "Could not generate report."}</p></div><button class="btn btn-sm btn-outline-secondary close-report-btn">Close</button>`;
            // Add listener to close button in error state
            reportCardBody.querySelector('.close-report-btn')?.addEventListener('click', () => {
                 reportCardBody.innerHTML = originalContent;
                 reportCardBody.querySelector('.generate-report-btn')?.addEventListener('click', handleGenerateReport);
            });
        }
    }


    // --- DOMContentLoaded Initialization ---
    document.addEventListener('DOMContentLoaded', function () {

        // --- Cache DOM Elements ---
        const adjustBudgetForm = document.getElementById('adjustBudgetForm');
        const adjustBudgetModalEl = document.getElementById('adjustBudgetModal');
        const adjustBudgetModal = adjustBudgetModalEl ? new bootstrap.Modal(adjustBudgetModalEl) : null;
        const budgetDisplay = document.querySelector('.budget-display');

        const addCategoryForm = document.getElementById('addCategoryForm');
        const addCategoryModalEl = document.getElementById('addCategoryModal');
        const addCategoryModal = addCategoryModalEl ? new bootstrap.Modal(addCategoryModalEl) : null;
        const categoryErrorAlert = document.getElementById('categoryErrorAlert');

        const budgetCategoryContainer = document.getElementById('budgetCategoryContainer');

        const addTransactionForm = document.getElementById('addTransactionForm');
        const addTransactionModalEl = document.getElementById('addTransactionModal');
        const addTransactionModal = addTransactionModalEl ? new bootstrap.Modal(addTransactionModalEl) : null;
        const transactionListBody = document.getElementById('transactionListBody');
        const totalSpentDisplay = document.getElementById('totalSpentDisplay');
        const transactionErrorAlert = document.getElementById('transactionErrorAlert');
        const transactionCategorySelect = document.getElementById('id_category'); // Verify this ID

        const darkModeToggle = document.getElementById('darkModeToggle');
        const moneyFlowChartDiv = document.getElementById('moneyFlowChart');

        // --- Initialize Chart Data ---
        chartCategories = []; // Reset arrays
        chartSpending = [];
        {% for category in template_data.budget_categories %}
            chartCategories.push("{{ category.name|escapejs }}");
            chartSpending.push({{ category.amount_spent|default:0 }});
        {% endfor %}
        chartData = [{ x: chartCategories, y: chartSpending, type: 'bar', width: 0.3, marker: { color: 'rgb(91, 192, 222)' } }];

        // --- Initial Chart Plotting ---
        if (moneyFlowChartDiv && typeof Plotly !== 'undefined'){
             const isInitiallyDark = localStorage.getItem('darkMode') === 'enabled';
             plotLayout.paper_bgcolor = isInitiallyDark ? '#1e1e1e' : '#fff';
             plotLayout.plot_bgcolor = isInitiallyDark ? '#1e1e1e' : '#fff';
             plotLayout.font.color = isInitiallyDark ? '#e0e0e0' : '#000';
             Plotly.newPlot(moneyFlowChartDiv, chartData, plotLayout, {responsive: true});
        } else if (typeof Plotly === 'undefined') {
             console.error("Plotly library not loaded.");
        }

        // --- Event Listeners ---

        // Adjust Monthly Budget
        if (adjustBudgetForm && adjustBudgetModal) {
            adjustBudgetForm.addEventListener('submit', function (event) {
                 event.preventDefault();
                 clearFormErrors(adjustBudgetForm);
                 const formData = new FormData(adjustBudgetForm);
                 fetch(adjustBudgetForm.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken } })
                 .then(response => { if (!response.ok) { return response.json().then(errData => { throw { status: response.status, data: errData }; }); } return response.json(); })
                 .then(data => {
                     if (data.status === 'success') {
                         if (budgetDisplay) { budgetDisplay.textContent = `Budget: $${parseFloat(data.new_budget).toFixed(2)}`; }
                         adjustBudgetModal.hide();
                     } else { handleFormErrors(adjustBudgetForm, data.form_errors, null, data.error); }
                 })
                 .catch(error => { console.error('Adjust Budget Fetch Error:', error); const msg = error?.data?.error || error?.data?.message || 'A network or server error occurred.'; handleFormErrors(adjustBudgetForm, error?.data?.form_errors, null, msg); });
            });
        }

        // Add Category
        if (addCategoryForm && addCategoryModal && budgetCategoryContainer) {
            addCategoryForm.addEventListener('submit', function (event) {
                event.preventDefault(); clearFormErrors(addCategoryForm); const formData = new FormData(addCategoryForm);
                fetch(addCategoryForm.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken } })
                .then(response => { if (!response.ok) { return response.json().then(errData => { throw { status: response.status, data: errData }; }); } return response.json(); })
                .then(data => {
                    if (data.status === 'success') {
                        const newCategoryDiv = document.createElement('div'); newCategoryDiv.className = 'col'; newCategoryDiv.id = `category-card-${data.category_id}`;
                        const initialSpent = 0.00; const limit = parseFloat(data.category_limit).toFixed(2); const percentage = 0;
                        newCategoryDiv.innerHTML = `<div class="card h-100"><div class="card-body position-relative"><h5 class="card-title">${data.category_name}</h5><p class="card-text">Budget: $${limit}</p><p class="card-text">Spent: $<span id="category-spent-${data.category_id}">${initialSpent.toFixed(2)}</span></p><div class="progress mb-4"><div class="progress-bar bg-info" style="width: ${percentage}%" role="progressbar" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div></div><button type="button" class="btn btn-sm btn-outline-danger delete-category-btn position-absolute bottom-0 end-0 mb-2 me-2" data-category-id="${data.category_id}" data-category-name="${data.category_name.replace(/"/g, '&quot;')}" title="Delete Category"><i class="fa fa-trash"></i></button></div></div>`;
                        budgetCategoryContainer.appendChild(newCategoryDiv);
                        // Update Chart
                        chartCategories.push(data.category_name); chartSpending.push(initialSpent);
                        if (moneyFlowChartDiv && typeof Plotly !== 'undefined') { Plotly.react(moneyFlowChartDiv, chartData, plotLayout); }
                        // Add to dropdown
                        if (transactionCategorySelect) { transactionCategorySelect.add(new Option(data.category_name, data.category_id)); }
                        addCategoryForm.reset(); addCategoryModal.hide();
                        if (document.body.classList.contains('dark-mode')) { applyDarkModeStyles(newCategoryDiv.querySelector('.card')); }
                    } else { handleFormErrors(addCategoryForm, data.form_errors, categoryErrorAlert, data.error); }
                })
                .catch(error => { console.error('Add Category Fetch Error:', error); const msg = error?.data?.error || error?.data?.message || 'A network or server error occurred.'; handleFormErrors(addCategoryForm, error?.data?.form_errors, categoryErrorAlert, msg); });
            });
        }

        // Add Transaction
        if (addTransactionForm && addTransactionModal && transactionListBody) {
            addTransactionForm.addEventListener('submit', function(event) {
                 event.preventDefault(); clearFormErrors(addTransactionForm); const formData = new FormData(addTransactionForm);
                 fetch(addTransactionForm.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken } })
                 .then(response => { if (!response.ok) { return response.json().then(errData => { throw { status: response.status, data: errData }; }); } return response.json(); })
                 .then(data => {
                     if (data.status === 'success') {
                         // Update Category Card
                         const categoryCard = document.getElementById(`category-card-${data.transaction.category_id}`);
                         if (categoryCard) { const budgetLimitText = categoryCard.querySelector('.card-text:nth-of-type(1)')?.textContent; const budgetLimitMatch = budgetLimitText?.match(/Budget: \$([\d.]+)/); if (budgetLimitMatch) { updateCategoryCardDisplay(data.transaction.category_id, data.updated_category_spent, budgetLimitMatch[1]); } }
                         // Update Total Spent
                         if (totalSpentDisplay) { totalSpentDisplay.textContent = parseFloat(data.total_spent).toFixed(2); }
                         // Add Transaction Row
                         const newRow = document.createElement('tr'); newRow.id = `transaction-row-${data.transaction.id}`; newRow.innerHTML = `<td>${data.transaction.date}</td><td>${data.transaction.category_name}</td><td>${data.transaction.description || '-'}</td><td class="text-end text-danger">-$${parseFloat(data.transaction.amount).toFixed(2)}</td>`;
                         const noTransactionRow = document.getElementById('no-transactions-row'); if (noTransactionRow) { noTransactionRow.remove(); }
                         transactionListBody.insertBefore(newRow, transactionListBody.firstChild);
                         if (document.body.classList.contains('dark-mode')) { applyDarkModeStyles(newRow); }
                         // Update Chart
                         let categoryIndex = chartCategories.indexOf(data.transaction.category_name); if (categoryIndex !== -1) { chartSpending[categoryIndex] = parseFloat(data.updated_category_spent); } else { console.warn("Category from transaction not found in chart data."); }
                         if (moneyFlowChartDiv && typeof Plotly !== 'undefined') { Plotly.react(moneyFlowChartDiv, chartData, plotLayout); }
                         // Reset & Hide
                         addTransactionForm.reset(); addTransactionModal.hide();
                     } else { handleFormErrors(addTransactionForm, data.form_errors, transactionErrorAlert, data.error); }
                 })
                 .catch(error => { console.error('Add Transaction Fetch Error:', error); const msg = error?.data?.error || error?.data?.message || 'A network or server error occurred.'; handleFormErrors(addTransactionForm, error?.data?.form_errors, transactionErrorAlert, msg); });
            });
        }

        // Delete Category (Delegation)
        if (budgetCategoryContainer) {
            budgetCategoryContainer.addEventListener('click', function(event) {
                const deleteButton = event.target.closest('.delete-category-btn');
                if (deleteButton) {
                    const categoryId = deleteButton.dataset.categoryId; const categoryName = deleteButton.dataset.categoryName;
                    if (confirm(`Are you sure you want to delete the category "${categoryName}"? This action cannot be undone.`)) {
                        const deleteUrl = `/dashboard/category/${categoryId}/delete/`; // *** VERIFY URL ***
                        fetch(deleteUrl, { method: 'DELETE', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken } })
                        .then(response => { if (response.ok) { return response.json(); } else { return response.json().then(errData => { throw { status: response.status, message: errData.message || `Server error: ${response.status}` }; }).catch(() => { throw { status: response.status, message: `Failed to delete category. Status: ${response.status}` }; }); } })
                        .then(data => {
                            if (data.status === 'success') {
                                document.getElementById(`category-card-${categoryId}`)?.remove();
                                transactionCategorySelect?.querySelector(`option[value="${categoryId}"]`)?.remove();
                                const indexToRemove = chartCategories.indexOf(categoryName);
                                if (indexToRemove > -1) { chartCategories.splice(indexToRemove, 1); chartSpending.splice(indexToRemove, 1); if (moneyFlowChartDiv && typeof Plotly !== 'undefined') { Plotly.react(moneyFlowChartDiv, chartData, plotLayout); } }
                                if (data.total_spent !== undefined && totalSpentDisplay) { totalSpentDisplay.textContent = parseFloat(data.total_spent).toFixed(2); }
                                console.log(`Category ${categoryId} deleted.`);
                                // Add user feedback (e.g., toast notification) here if desired
                            } else { throw { status: 200, message: data.message || 'Deletion failed.' }; }
                        })
                        .catch(error => { console.error('Error deleting category:', error); alert(`Error: ${error.message || 'Could not delete category.'}`); });
                    }
                }
            });
        }

        // Dark Mode Toggle
        if (darkModeToggle) {
            darkModeToggle.addEventListener('change', toggleDarkMode);
            if (localStorage.getItem('darkMode') === 'enabled') {
                 darkModeToggle.checked = true;
                 toggleDarkMode(); // Apply styles on load
            }
        }

        // Generate Report Button
        // Use event delegation on a parent container if the button might be re-rendered
        const reportSection = document.getElementById('spendingHabitsReportSection');
        if (reportSection) {
             reportSection.addEventListener('click', function(event) {
                 if (event.target.matches('.generate-report-btn')) {
                      handleGenerateReport();
                 }
             });
        } else {
             console.error("Could not find spending habits report section to attach delegated listener.");
        }

    }); // End DOMContentLoaded

</script>
{% endblock content %}
